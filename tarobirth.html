<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>생일수 계산기</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5f5f5;
            --text-color: #333;
            --border-color: #dee2e6;
            --error-color: #dc3545;
            --success-color: #28a745;
        }

        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--secondary-color);
            color: var(--text-color);
        }

        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .input-group {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }

        .card-result {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background-color: var(--secondary-color);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card h3 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }

        select {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            min-width: 80px;
            background-color: white;
        }

        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }

        .radio-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .card-info {
            margin-top: 10px;
        }

        .card-name {
            color: var(--primary-color);
            font-weight: bold;
            margin: 5px 0;
        }

        .card-meaning {
            color: #666;
            font-size: 0.9em;
            margin: 5px 0;
            line-height: 1.4;
        }

        .date-display {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .error-message {
            color: var(--error-color);
            font-size: 0.9em;
            margin-top: 5px;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 10px 0;
            color: var(--primary-color);
        }

        @media (max-width: 600px) {
            .card-result {
                grid-template-columns: 1fr;
            }

            .date-inputs {
                flex-direction: column;
                align-items: stretch;
            }

            select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>타로 생일수 계산기</h1>
        <div id="errorContainer" class="error-message" role="alert"></div>

        <div class="input-group">
            <div class="radio-group">
                <label>
                    <input type="radio" name="calendarType" value="solar" checked>
                    양력
                </label>
                <label>
                    <input type="radio" name="calendarType" value="lunar">
                    음력
                </label>
            </div>

            <div class="date-inputs">
                <select id="year" aria-label="년도 선택"></select>
                <select id="month" aria-label="월 선택"></select>
                <select id="day" aria-label="일 선택"></select>
            </div>
        </div>

        <div id="loading" class="loading">변환 중...</div>

        <div class="card-result">
            <div class="card">
                <h3>양력 카드</h3>
                <div class="date-display" id="solarDate">양력: -</div>
                <div id="solarCardInfo" class="card-info"></div>
            </div>
            <div class="card">
                <h3>음력 카드</h3>
                <div class="date-display" id="lunarDate">음력: -</div>
                <div id="lunarCardInfo" class="card-info"></div>
            </div>
            <div class="card">
                <h3>그림자 카드</h3>
                <div id="shadowCardInfo" class="card-info"></div>
            </div>
            <div class="card">
                <h3>소울 카드</h3>
                <div id="soulCardInfo" class="card-info"></div>
            </div>
        </div>
    </div>

    <script>
        // API 키 (Decoding 된 키 사용)
        const API_KEY = 'MILYiLsWAQ6xS8wiGu+0xnqhHeVSyR0OCXDQGAwVLbjJHK1ZHunwfpiDCFv/qZoPfug6onGR/VBNmOdaf85n5g==';
        const BASE_URL = 'https://apis.data.go.kr/B090041/openapi/service/LrsrCldInfoService';

        const yearSelect = document.getElementById('year');
        const monthSelect = document.getElementById('month');
        const daySelect = document.getElementById('day');
        const loadingElement = document.getElementById('loading');
        const currentYear = new Date().getFullYear();

        const tarotCards = [
            {
                name: "광대(The Fool)",
                meaning: "새로운 시작, 순수함, 자유로움, 모험심. 편견 없이 세상을 바라보는 순수한 영혼의 상태를 의미합니다."
            },
            {
                name: "마법사(The Magician)",
                meaning: "창의력, 의지력, 숙련된 기술, 자기확신. 자신의 재능과 능력을 최대한 발휘하여 목표를 달성할 수 있음을 의미합니다."
            },
            {
                name: "여사제(The High Priestess)",
                meaning: "직관, 신비, 내면의 지혜, 잠재의식. 깊은 통찰력과 영적인 지혜를 상징합니다."
            },
            {
                name: "여제(The Empress)",
                meaning: "풍요, 창조력, 모성, 자연의 순환. 성장과 번영, 풍요로움을 상징합니다."
            },
            {
                name: "황제(The Emperor)",
                meaning: "권위, 리더십, 안정성, 체계. 질서와 통제, 합리적인 판단력을 상징합니다."
            },
            {
                name: "교황(The Hierophant)",
                meaning: "전통, 교육, 영적 지도, 종교. 정신적 가치와 전통적인 가르침을 상징합니다."
            },
            {
                name: "연인(The Lovers)",
                meaning: "사랑, 조화, 관계, 선택. 중요한 결정과 진정한 파트너십을 상징합니다."
            },
            {
                name: "전차(The Chariot)",
                meaning: "성공, 의지력, 승리, 전진. 목표를 향한 강한 의지와 추진력을 상징합니다."
            },
            {
                name: "힘(Strength)",
                meaning: "내면의 힘, 용기, 인내, 자제력. 정신적 강인함과 내면의 힘을 상징합니다."
            },
            {
                name: "은둔자(The Hermit)",
                meaning: "성찰, 고독, 내면의 탐색, 지혜. 자기 성찰과 내적 성장을 상징합니다."
            },
            {
                name: "운명의 수레바퀴(The Wheel of Fortune)",
                meaning: "변화, 운명, 기회, 순환. 인생의 변화와 새로운 기회를 상징합니다."
            },
            {
                name: "정의(Justice)",
                meaning: "균형, 공정, 진실, karma. 공정한 판단과 균형 잡힌 결정을 상징합니다."
            },
            {
                name: "매달린 사람(The Hanged Man)",
                meaning: "희생, 새로운 관점, 영적 깨달음. 기존 관점에서 벗어나 새로운 시각을 얻는 것을 상징합니다."
            },
            {
                name: "죽음(Death)",
                meaning: "변화, 종료, 변환, 재생. 큰 변화와 새로운 시작을 상징합니다."
            },
            {
                name: "절제(Temperance)",
                meaning: "균형, 조화, 중용, 치유. 조화로운 삶과 내면의 평화를 상징합니다."
            },
            {
                name: "악마(The Devil)",
                meaning: "집착, 속박, 유혹, 물질주의. 자신을 구속하는 부정적인 패턴이나 집착을 상징합니다."
            },
            {
                name: "탑(The Tower)",
                meaning: "급격한 변화, 파괴, 각성, 해방. 기존 구조의 붕괴와 새로운 시작을 상징합니다."
            },
            {
                name: "별(The Star)",
                meaning: "희망, 영감, 평화, 치유. 밝은 미래에 대한 희망과 영감을 상징합니다."
            },
            {
                name: "달(The Moon)",
                meaning: "환상, 직관, 불확실성, 잠재의식. 내면의 두려움과 직관적 통찰을 상징합니다."
            },
            {
                name: "태양(The Sun)",
                meaning: "기쁨, 성공, 활력, 명료함. 긍정적 에너지와 성공을 상징합니다."
            },
            {
                name: "심판(Judgement)",
                meaning: "재생, 각성, 변화, 소명. 인생의 새로운 단계와 소명을 발견함을 상징합니다."
            },
            {
                name: "세계(The World)",
                meaning: "완성, 성취, 통합, 여행. 목표 달성과 완성을 상징합니다."
            }
        ];

        function initializeDateSelects() {
            yearSelect.innerHTML = '<option value="">년도</option>';
            for (let y = currentYear; y >= 1900; y--) {
                yearSelect.innerHTML += `<option value="${y}">${y}년</option>`;
            }

            monthSelect.innerHTML = '<option value="">월</option>';
            for (let m = 1; m <= 12; m++) {
                monthSelect.innerHTML += `<option value="${m.toString().padStart(2, '0')}">${m}월</option>`;
            }

            updateDays();
        }

        function updateDays() {
            const year = parseInt(yearSelect.value) || currentYear;
            const month = parseInt(monthSelect.value) || 1;
            const lastDay = new Date(year, month, 0).getDate();

            daySelect.innerHTML = '<option value="">일</option>';
            for (let d = 1; d <= lastDay; d++) {
                daySelect.innerHTML += `<option value="${d.toString().padStart(2, '0')}">${d}일</option>`;
            }

            if (parseInt(daySelect.value) > lastDay) {
                daySelect.value = '';
            }
        }

        async function convertDate(year, month, day, isSolar) {
            const endpoint = isSolar ? 'getLunCalInfo' : 'getSolCalInfo';
            const dateType = isSolar ? 'sol' : 'lun';

            try {
                loadingElement.style.display = 'block';

                // API URL 구성
                const params = new URLSearchParams({
                    serviceKey: API_KEY,
                    [`${dateType}Year`]: year,
                    [`${dateType}Month`]: month.toString().padStart(2, '0'),
                    [`${dateType}Day`]: day.toString().padStart(2, '0')
                });

                const apiUrl = `${BASE_URL}/${endpoint}?${params}`;

                // CORS 우회를 위한 프록시 URL 및 헤더
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/'; // 프록시 서버 변경
                //const proxyUrl = 'https://proxy.cors.sh/';
                //const headers = {
                //    'x-cors-api-key': 'temp_d89c2d8fcfcb079dca45ab5315f80d5d' // 사용하지 않음
                //};
                const headers = {}; // CORS Anywhere는 헤더가 필요 없음

                const response = await fetch(proxyUrl + apiUrl, { headers });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTP error details:', response.status, response.statusText, errorText);
                    throw new Error(`HTTP error! status: ${response.status}, ${response.statusText}, ${errorText}`);
                }

                const text = await response.text();
                console.log('API Response:', text); // API 응답 내용 로깅

                // XML 파싱 에러 체크
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(text, "text/xml");

                if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                    const parserErrorText = xmlDoc.getElementsByTagName('parsererror')[0].textContent;
                    throw new Error('XML 파싱 오류가 발생했습니다: ' + parserErrorText);
                }

                // API 응답 에러 체크
                const errorCodeElement = xmlDoc.querySelector('resultCode');
                const errorMsgElement = xmlDoc.querySelector('resultMsg');

                if (errorCodeElement) {
                    const code = errorCodeElement.textContent;
                    const message = errorMsgElement ? errorMsgElement.textContent : '알 수 없는 오류';
                    if (code !== '00') {
                        throw new Error(`API 오류: ${message} (코드: ${code})`);
                    }
                }

                // 결과 데이터 추출
                const item = xmlDoc.querySelector('item');
                if (!item) {
                    throw new Error('날짜 정보를 찾을 수 없습니다.');
                }

                // 안전한 데이터 추출을 위한 헬퍼 함수
                const safeParseInt = (element) => {
                    if (!element) return null;
                    const value = parseInt(element.textContent);
                    return isNaN(value) ? null : value;
                };

                const getElementText = (parent, selector) => {
                    const element = parent.querySelector(selector);
                    return element ? element.textContent : null;
                };

                // 데이터 추출
                const solar = {
                    year: safeParseInt(item.querySelector('solYear')),
                    month: safeParseInt(item.querySelector('solMonth')),
                    day: safeParseInt(item.querySelector('solDay'))
                };

                const lunar = {
                    year: safeParseInt(item.querySelector('lunYear')),
                    month: safeParseInt(item.querySelector('lunMonth')),
                    day: safeParseInt(item.querySelector('lunDay'))
                };

                // 데이터 유효성 검사
                if (!solar.year || !solar.month || !solar.day ||
                    !lunar.year || !lunar.month || !lunar.day) {
                    throw new Error('날짜 데이터가 올바르지 않습니다.');
                }

                return { solar, lunar };

            } catch (error) {
                console.error('Error in convertDate:', error);
                document.getElementById('errorContainer').textContent = '날짜 변환 중 오류가 발생했습니다: ' + error.message;
                throw error; // 오류를 다시 던져 상위 함수에서 처리하도록 함
            } finally {
                loadingElement.style.display = 'none';
            }
        }

        async function calculateCards() {
            if (!validateInputs()) return;

            const year = yearSelect.value;
            const month = monthSelect.value;
            const day = daySelect.value;
            const isSolar = document.querySelector('input[name="calendarType"]:checked').value === 'solar';

            try {
                const dateInfo = await convertDate(year, month, day, isSolar);

                // 결과 표시
                document.getElementById('solarDate').textContent =
                    `양력: ${dateInfo.solar.year}년 ${dateInfo.solar.month}월 ${dateInfo.solar.day}일`;
                document.getElementById('lunarDate').textContent =
                    `음력: ${dateInfo.lunar.year}년 ${dateInfo.lunar.month}월 ${dateInfo.lunar.day}일`;

                const solarSum = calculateSingleDigit(
                    dateInfo.solar.year + dateInfo.solar.month + dateInfo.solar.day
                );

                // 각 카드 정보 표시
                displayCardInfo('solarCardInfo', solarSum);
                displayCardInfo('lunarCardInfo',
                    calculateSingleDigit(dateInfo.lunar.year + dateInfo.lunar.month + dateInfo.lunar.day));
                displayCardInfo('shadowCardInfo', 22 - solarSum);
                displayCardInfo('soulCardInfo', solarSum > 21 ? solarSum - 22 : solarSum);

                document.getElementById('errorContainer').textContent = '';

            } catch (error) {
                console.error('Error in calculateCards:', error);
                document.getElementById('errorContainer').textContent = error.message;
                clearDisplays();
            }
        }

        function validateInputs() {
            if (!yearSelect.value || !monthSelect.value || !daySelect.value) {
                document.getElementById('errorContainer').textContent = '년, 월, 일을 모두 선택해주세요.';
                return false;
            }
            return true;
        }

        function calculateSingleDigit(number) {
            let sum = String(number).split('').map(Number).reduce((a, b) => a + b, 0);
            while (sum > 22) {
                sum = String(sum).split('').map(Number).reduce((a, b) => a + b, 0);
            }
            return sum;
        }

        function displayCardInfo(elementId, cardNumber) {
            const card = tarotCards[(cardNumber - 1 + tarotCards.length) % tarotCards.length]; // cardNumber가 0일 때도 처리
            const cardInfoDiv = document.getElementById(elementId);
            cardInfoDiv.innerHTML = `
                <div class="card-name">${card.name}</div>
                <div class="card-meaning">${card.meaning}</div>
            `;
        }

        function clearDisplays() {
            document.getElementById('solarDate').textContent = '양력: -';
            document.getElementById('lunarDate').textContent = '음력: -';
            document.getElementById('solarCardInfo').innerHTML = '';
            document.getElementById('lunarCardInfo').innerHTML = '';
            document.getElementById('shadowCardInfo').innerHTML = '';
            document.getElementById('soulCardInfo').innerHTML = '';
        }

        yearSelect.addEventListener('change', updateDays);
        monthSelect.addEventListener('change', updateDays);

        // 이벤트 리스너 등록
        document.querySelectorAll('input[name="calendarType"]').forEach(radio => {
            radio.addEventListener('change', calculateCards);
        });
        yearSelect.addEventListener('change', calculateCards);
        monthSelect.addEventListener('change', calculateCards);
        daySelect.addEventListener('change', calculateCards);

        initializeDateSelects(); // 페이지 로드 시 초기화
        calculateCards(); // 초기 카드 계산
    </script>
</body>
</html>
